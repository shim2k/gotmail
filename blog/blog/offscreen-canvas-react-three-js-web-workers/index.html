<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.76e68739b84e4dfae8e9.css">code[class*=language-],pre[class*=language-]{color:#c5c8c6;text-shadow:0 1px rgba(0,0,0,.3);font-family:Inconsolata,Monaco,Consolas,Courier New,Courier,monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#1d1f21}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#7c7c7c}.token.punctuation{color:#c5c8c6}.namespace{opacity:.7}.token.keyword,.token.property,.token.tag{color:#96cbfe}.token.class-name{color:#ffffb6;text-decoration:underline}.token.boolean,.token.constant{color:#9c9}.token.deleted,.token.symbol{color:#f92672}.token.number{color:#ff73fd}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a8ff60}.token.variable{color:#c6c5fe}.token.operator{color:#ededed}.token.entity{color:#ffffb6}.token.url{color:#96cbfe}.language-css .token.string,.style .token.string{color:#87c38a}.token.atrule,.token.attr-value{color:#f9ee98}.token.function{color:#dad085}.token.regex{color:#e9c062}.token.important{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}pre[class*=language-].line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:200;src:local("Nunito Extra Light "),local("Nunito-Extra Light"),url(/static/nunito-latin-200-2a4f4b0a3646be9d8560178ebc4306e5.woff2) format("woff2"),url(/static/nunito-latin-200-249c20ee4450b15795cdde4cbb5f38d8.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:200;src:local("Nunito Extra Light italic"),local("Nunito-Extra Lightitalic"),url(/static/nunito-latin-200italic-89ba5530f3b2c751f2a49e25f31e3f15.woff2) format("woff2"),url(/static/nunito-latin-200italic-67d3d63c0ac28ccbc0c0fcbda8e66e04.woff) format("woff")}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:300;src:local("Nunito Light "),local("Nunito-Light"),url(/static/nunito-latin-300-895205e22ad7d4d866df7102352077cd.woff2) format("woff2"),url(/static/nunito-latin-300-cad1324b066f52f764cf080d9244c8b2.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:300;src:local("Nunito Light italic"),local("Nunito-Lightitalic"),url(/static/nunito-latin-300italic-f4a613c73f19da60cf08aa42b2a9249b.woff2) format("woff2"),url(/static/nunito-latin-300italic-1fde36925a8493f45651815dd89d22a7.woff) format("woff")}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:400;src:local("Nunito Regular "),local("Nunito-Regular"),url(/static/nunito-latin-400-de6068bf97f40206af0b062e262e6213.woff2) format("woff2"),url(/static/nunito-latin-400-6386ba6af7b7a5480eb5efda82ff803c.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:400;src:local("Nunito Regular italic"),local("Nunito-Regularitalic"),url(/static/nunito-latin-400italic-6ca737afe5cef0c0a9c9bbfec4e398ff.woff2) format("woff2"),url(/static/nunito-latin-400italic-ef2e2a0d9dd85cf89526d1f27f8fbbef.woff) format("woff")}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:600;src:local("Nunito SemiBold "),local("Nunito-SemiBold"),url(/static/nunito-latin-600-b10ecee279e3a8d11d5ec3193b68d8bf.woff2) format("woff2"),url(/static/nunito-latin-600-c3de23017bcb95715e6eb11dd6a10fc5.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:600;src:local("Nunito SemiBold italic"),local("Nunito-SemiBolditalic"),url(/static/nunito-latin-600italic-97d4f64b213f3e5163827754c213bb4e.woff2) format("woff2"),url(/static/nunito-latin-600italic-4f62b81ff327bd0ffadcb7b82e6c13b2.woff) format("woff")}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:700;src:local("Nunito Bold "),local("Nunito-Bold"),url(/static/nunito-latin-700-91ae827aa880d02ea567979add1da58c.woff2) format("woff2"),url(/static/nunito-latin-700-623f5ed42b0b347fb4531ded4e4b57a2.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:700;src:local("Nunito Bold italic"),local("Nunito-Bolditalic"),url(/static/nunito-latin-700italic-b94caac4c88b1fe6c4faf6256646f42e.woff2) format("woff2"),url(/static/nunito-latin-700italic-3aabf345871453097c2d8762411d187e.woff) format("woff")}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:800;src:local("Nunito ExtraBold "),local("Nunito-ExtraBold"),url(/static/nunito-latin-800-36e4c9b478c2e2adb339a76d819eed7e.woff2) format("woff2"),url(/static/nunito-latin-800-33c733aff58ea08126616f346cbf4f4a.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:800;src:local("Nunito ExtraBold italic"),local("Nunito-ExtraBolditalic"),url(/static/nunito-latin-800italic-0f20328772c0d84250ef397c129607fb.woff2) format("woff2"),url(/static/nunito-latin-800italic-672d2afe4f40a766e46ff95379550c4f.woff) format("woff")}@font-face{font-family:Nunito;font-style:normal;font-display:swap;font-weight:900;src:local("Nunito Black "),local("Nunito-Black"),url(/static/nunito-latin-900-b296e05d0932e16d500b753becdb338e.woff2) format("woff2"),url(/static/nunito-latin-900-cbf4339e858edf2b14d20140b2887343.woff) format("woff")}@font-face{font-family:Nunito;font-style:italic;font-display:swap;font-weight:900;src:local("Nunito Black italic"),local("Nunito-Blackitalic"),url(/static/nunito-latin-900italic-ae87e7b4e2d3825919b9bc6c82039b80.woff2) format("woff2"),url(/static/nunito-latin-900italic-602859bd469800c6205701f5a16b1a1b.woff) format("woff")}code{background-color:rgba(0,0,0,.04)}body{margin:0;font-family:Nunito,Avenir,Helvetica,"sans-serif";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{font-style:normal;color:rgba(0,0,0,.8);-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em georgia,serif;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt"}img{max-width:100%;padding:0;margin:0 0 1.45rem}h1{font-size:2.25rem}h1,h2{padding:0;margin:0 0 1.45rem;color:inherit;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{padding:0;margin:0 0 1.45rem;color:inherit;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{padding:0;margin:0 0 1.45rem;color:inherit;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{padding:0;margin:0 0 1.45rem}ol,ul{padding:0;margin:0 0 1.45rem 1.45rem;list-style-position:outside;list-style-image:none}dd,dl,figure,p{padding:0;margin:0 0 1.45rem}pre{margin:0 0 1.45rem;font-size:.8rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}table{font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset,table{padding:0;margin:0 0 1.45rem}blockquote{padding:0;margin:0 1.45rem 1.45rem}form,iframe,noscript{padding:0;margin:0 0 1.45rem}hr{padding:0;margin:0 0 calc(1.45rem - 1px);background:rgba(0,0,0,.2);border:none;height:1px}address{padding:0;margin:0 0 1.45rem}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.8rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}.gatsby-highlight{background-color:#1d1f21;border-radius:.3em;margin:.5em 0;padding:1em;overflow:auto}.gatsby-highlight pre[class*=language-].line-numbers{padding:0 0 0 2.8em;overflow:initial}@media only screen and (max-width:480px){html{font-size:100%}}</style><meta name="generator" content="Gatsby 2.13.57"/><title data-react-helmet="true">Three.js, Web Workers and OffscreenCanvas in React | Shimi Razilov</title><meta data-react-helmet="true" name="description" content="Three.js gives us the ability to create and display animated 3D graphics inside the browser.
It uses WebGL, Canvas and SVG in order to render the graphics…"/><meta data-react-helmet="true" property="og:title" content="Three.js, Web Workers and OffscreenCanvas in React"/><meta data-react-helmet="true" property="og:description" content="Three.js gives us the ability to create and display animated 3D graphics inside the browser.
It uses WebGL, Canvas and SVG in order to render the graphics…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="@shim2k"/><meta data-react-helmet="true" name="twitter:title" content="Three.js, Web Workers and OffscreenCanvas in React"/><meta data-react-helmet="true" name="twitter:description" content="Three.js gives us the ability to create and display animated 3D graphics inside the browser.
It uses WebGL, Canvas and SVG in order to render the graphics…"/><link rel="shortcut icon" href="/icons/icon-48x48.png?v=008654519ce705ac7bc44303a9014606"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=008654519ce705ac7bc44303a9014606"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=008654519ce705ac7bc44303a9014606"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link as="script" rel="preload" href="/webpack-runtime-6d305035b2c751f58eee.js"/><link as="script" rel="preload" href="/app-8e99590c6c6e7125957b.js"/><link as="script" rel="preload" href="/styles-ac8511ad3386f46bed10.js"/><link as="script" rel="preload" href="/1-439d3d9c19b1d3b47fde.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-92c2df92fee3b8e3db06.js"/><link as="fetch" rel="preload" href="/page-data/blog/offscreen-canvas-react-three-js-web-workers/page-data.json" crossorigin="use-credentials"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><style data-emotion-css="1pyi7sa">.css-1pyi7sa{background:transparent;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-content:center;-ms-flex-line-pack:center;align-content:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}</style><header class="css-1pyi7sa e2i1wbd3"><style data-emotion-css="k1grrt">.css-k1grrt{max-width:860px;padding:1rem 1.0875rem;font-size:1.2rem;}</style><div class="css-k1grrt e2i1wbd0"></div></header><style data-emotion-css="1813l62">.css-1813l62{margin:0 auto;max-width:860px;padding:0 1.0875rem 1rem;padding-top:0;}</style><div class="css-1813l62 e1ehxxwc0"><main><style data-emotion-css="hu0znc">.css-hu0znc{margin:0 auto;max-width:860px;padding:1.45rem 1.0875rem;}</style><div class="css-hu0znc e1v73u8h0"><style data-emotion-css="tot80j">.css-tot80j{display:inline;border-radius:1em 0 1em 0;background-image:linear-gradient( -100deg,rgba(150,196,255,0.1),rgba(150,196,255,0.2) 100%,rgba(150,196,255,0.15) );}</style><h1 class="css-tot80j e1v73u8h1">Three.js, Web Workers and OffscreenCanvas in React</h1><style data-emotion-css="wvcn4j">.css-wvcn4j{margin-top:10px;color:#606060;}</style><h3 class="css-wvcn4j e1v73u8h2">12 August, 2019<!-- --> - <!-- -->5 min read</h3><style data-emotion-css="1rcp9ax">.css-1rcp9ax a{-webkit-text-decoration:none;text-decoration:none;position:relative;}.css-1rcp9ax a::after{content:"";position:absolute;z-index:-1;top:70%;left:-0.1px;right:-0.1px;bottom:0;-webkit-transition:top 0.1s ease-in-out;transition:top 0.1s ease-in-out;background-color:rgba(255,250,150,0.8);}.css-1rcp9ax a:hover::after{top:0;}</style><div class="css-1rcp9ax e1v73u8h3"><p>Three.js gives us the ability to create and display animated 3D graphics inside the browser.
It uses WebGL, Canvas and SVG in order to render the graphics.</p>
<p>Unfortunately, complex scenes can take time to render into the screen and while doing so, the main thread is too busy to handle events and process other logic, which will freeze your application amd make it unresponsive while Three.js rendering is in process.</p>
<p>In order to solve this problem, we are going to use to use two Web APIs interfaces:</p>
<h3>Web Workers</h3>
<p>Web Workers are a way for web applications to run scripts in background threads.
A worker thread can perform heavy tasks without interfering directly with the main thread, and thus user experience is not undermined.</p>
<p>Workers can only interact with the main thread by listening to the <code class="language-text">onmessage</code> event and by sending a message with the <code class="language-text">postMessage</code> method.</p>
<p>They also have various limitation including not being able to access the DOM and therefore cannot create or update DOM elements</p>
<h3>OffscreenCanvas</h3>
<p>The OffscreenCanvas interface for canvas is available as of Chrome 69 and Firefox 46 versions
and it provides us with the capability to render canvas off screen, as the name suggests. it is available in both the window (the main thread) and worker contexts.</p>
<p>Because Three.js uses canvas in order to render its 3D elements, we should be able to offload the Three.js rendering into OffscreenCanvas under a Web Worker.
This can boost the performance and responsiveness of web applications significantly.</p>
<h1>Integrating into React</h1>
<p>This tutorial assumes a Create-React-App 2.0 project or a Webpack-based build process (can be an ejected CRA)</p>
<p>First of all, we would like to add Web Workers into our build system.
Fortunately, CRA 2.0 already comes with Web Workers support opt-in, with the convention that files ending with .worker.js will be Workers</p>
<p>For ejected CRA projects you need to install the <code class="language-text">worker-loader</code> and <code class="language-text">thread-loader</code> packages add the following module in your webpack config:</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token punctuation">{</span>
  test<span class="token punctuation">:</span> <span class="token regex">/\.worker\.(js|jsx|mjs)$/</span><span class="token punctuation">,</span>
  include<span class="token punctuation">:</span> paths<span class="token punctuation">.</span>appSrc<span class="token punctuation">,</span>
  use<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"worker-loader"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// This loader parallelizes code compilation, it is optional but</span>
    <span class="token comment">// improves compile time on larger projects</span>
    require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"thread-loader"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      loader<span class="token punctuation">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"babel-loader"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// @remove-on-eject-begin</span>
        babelrc<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        presets<span class="token punctuation">:</span> <span class="token punctuation">[</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"babel-preset-react-app"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment">// @remove-on-eject-end</span>
        <span class="token comment">// This is a feature of `babel-loader` for webpack (not Babel itself).</span>
        <span class="token comment">// It enables caching results in ./node_modules/.cache/babel-loader/</span>
        <span class="token comment">// directory for faster rebuilds.</span>
        cacheDirectory<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        highlightCode<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>For more information on how to integrate this webpack loader refer to <a href="https://github.com/webpack-contrib/worker-loader">worker-loader</a>.</p>
<p>So now that we have Web Workers enabled, lets start by creating a component to display our Three.js scenes:</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// component.jsx</span>

<span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span>Component<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token comment">// importing a file ending with .worker.js to be the worker:</span>
<span class="token keyword">import</span> Worker <span class="token keyword">from</span> <span class="token string">'./scene.worker'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">SceneView</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Instantiating the worker</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
            isLoaded<span class="token punctuation">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function-variable function">componentDidMount</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">{</span>canvas<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token punctuation">{</span>clientHeight<span class="token punctuation">,</span> clientWidth<span class="token punctuation">}</span> <span class="token operator">=</span> canvas<span class="token punctuation">;</span>

        <span class="token comment">// Creating an OffscreenCanvas element. </span>
        <span class="token comment">// Rendering changes in this object will be reflected</span>
        <span class="token comment">// and displayed on the original canvas.</span>
        <span class="token keyword">const</span> offscreenCanvas <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">transferControlToOffscreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// worker.postMessage is a method </span>
        <span class="token comment">// which sends a message to the worker's inner scope.</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            type<span class="token punctuation">:</span> <span class="token string">'run'</span><span class="token punctuation">,</span>
            canvas<span class="token punctuation">:</span> offscreenCanvas<span class="token punctuation">,</span>
            sizes<span class="token punctuation">:</span> <span class="token punctuation">{</span>width<span class="token punctuation">:</span> clientWidth<span class="token punctuation">,</span> height<span class="token punctuation">:</span> clientHeight<span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>offscreenCanvas<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// worker.onmessage event will be invoked by the worker</span>
        <span class="token comment">// whenever the rendering process is done.</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'resolved'</span><span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span>isLoaded<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      
        <span class="token comment">// Sending a message to the worker </span>
        <span class="token comment">// so it can stop the Three.js animation process</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span> <span class="token string">'stop'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>div<span class="token operator">></span>
                <span class="token operator">&lt;</span>canvas
                    style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>width<span class="token punctuation">:</span> <span class="token string">'100%'</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token string">'100%'</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
                    ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">view</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>canvas <span class="token operator">=</span> view
                    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>canvas<span class="token operator">></span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>isLoaded <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> <span class="token operator">&lt;</span>div<span class="token operator">></span>Loading<span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
                <span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>The component will instantiate a worker in its constructor,
then after it is mounted we handle the the communication with the worker.</p>
<p>This is the object that we are sending to the worker:</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> <span class="token string">'run'</span><span class="token punctuation">,</span> <span class="token comment">// indicates which function in the worker's scope we would like to execute.</span>
  canvas<span class="token punctuation">:</span> offscreenCanvas<span class="token punctuation">,</span> canvas<span class="token punctuation">,</span> <span class="token comment">// contains the OffscreenCanvas element that the worker will use for rendering</span>
  sizes<span class="token punctuation">:</span> <span class="token punctuation">{</span>width<span class="token punctuation">:</span> clientWidth<span class="token punctuation">,</span> height<span class="token punctuation">:</span> clientHeight<span class="token punctuation">}</span> <span class="token comment">// contains the canvas sizes which are not available under the OffscreenObject</span>
<span class="token punctuation">}</span>    </code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Let's create the worker file:</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// scene.worker.js</span>

<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">THREE</span> <span class="token keyword">from</span> <span class="token string">'three'</span><span class="token punctuation">;</span>

<span class="token comment">// We define the handlers for the various message types</span>
<span class="token keyword">const</span> handlers <span class="token operator">=</span> <span class="token punctuation">{</span>
    run<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token comment">// We check whether we have a handler for this message type.</span>
    <span class="token comment">// If so, we call it.</span>
    <span class="token keyword">const</span> fn <span class="token operator">=</span> handlers<span class="token punctuation">[</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">no handler for type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fn</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">createCylider</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> geometry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>CylinderGeometry</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> material <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>MeshBasicMaterial</span><span class="token punctuation">(</span><span class="token punctuation">{</span>color<span class="token punctuation">:</span> <span class="token string">'red'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Mesh</span><span class="token punctuation">(</span>geometry<span class="token punctuation">,</span> material<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">run</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  
  <span class="token keyword">let</span> <span class="token punctuation">{</span> canvas <span class="token punctuation">}</span> <span class="token operator">=</span> message<span class="token punctuation">;</span>
  <span class="token keyword">let</span> cylider <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">createCylider</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
  <span class="token keyword">let</span> scene <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Scene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cylider<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">let</span> renderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>WebGLRenderer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>canvas<span class="token punctuation">,</span> alpha<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> antialias<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> preserveDrawingBuffer<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token operator">...</span>
  
  self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token punctuation">:</span> <span class="token string">'resolved'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>The onmessage event handler is implemented and routes the message to the right function.</p>
<p>As you can see, the <code class="language-text">run</code> function is creating a Three.js cylinder element, a scene and a renderer.
Once rendered</p>
<p>It is also emits an event once the rendering is completed to let the React component know about it.</p>
<h1>Conclusion</h1>
<p>If you are using Three.js heavily inside your React application you might want to consider using OffscreenCanvas
and Web Workers to improve the responsiveness and performance of your appm and make better use of multi-core systems.
Of course this code this very minimal but its purpose is to encourage more use of background rendering for Three.js.</p></div></div></main></div><style data-emotion-css="1l4w6pd">.css-1l4w6pd{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}</style><footer class="css-1l4w6pd e1ehxxwc3"><style data-emotion-css="o5uqvq">.css-o5uqvq{margin-left:5px;}</style><a href="https://twitter.com/shim2k" class="css-o5uqvq e1ehxxwc1">@shim2k</a><a href="https://github.com/Shim2k" class="css-o5uqvq e1ehxxwc1">github.com/shim2k</a></footer><style data-emotion-css="yxndpy">.css-yxndpy{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-top:5px;color:gray;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}</style><div class="css-yxndpy e1ehxxwc2">shim2k@gmail.com</div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-145433609-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/offscreen-canvas-react-three-js-web-workers";window.webpackCompilationHash="0254b86369c8ce8ab333";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-8e99590c6c6e7125957b.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-92c2df92fee3b8e3db06.js"],"component---src-pages-404-js":["/component---src-pages-404-js-512871976411c3d22198.js"],"component---src-pages-blog-js":["/component---src-pages-blog-js-77249118927d50d6b999.js"],"component---src-pages-index-js":["/component---src-pages-index-js-a39218c518bdc914026d.js"],"component---src-pages-projects-js":["/component---src-pages-projects-js-fd938cecb0773b8c9ab8.js"]};/*]]>*/</script><script src="/component---src-templates-blog-post-js-92c2df92fee3b8e3db06.js" async=""></script><script src="/1-439d3d9c19b1d3b47fde.js" async=""></script><script src="/styles-ac8511ad3386f46bed10.js" async=""></script><script src="/app-8e99590c6c6e7125957b.js" async=""></script><script src="/webpack-runtime-6d305035b2c751f58eee.js" async=""></script></body></html>